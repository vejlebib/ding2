<?php

/**
 * @file
 * Ting subsearch using Bibliotek.dk service.
 */

// Load admin configuration.
module_load_include('inc', 'ting_subsearch_secondary', 'ting_subsearch_secondary.admin');

/**
 * Implements hook_menu().
 */
function ting_subsearch_secondary_menu() {
  $items['subsearch_secondary'] = [
    'title' => 'Subsearch Secondary Suggestions',
    'description' => 'AJAXify request for subsearch secondary suggestions',
    'page callback' => 'ting_subsearch_secondary_ajax_callback',
    'access callback' => TRUE,
  ];

  return $items;
}

/**
 * Custom AJAX menu callback.
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_ajax_callback() {
  $message = '';
  if (!empty($_POST['keys']) && isset($_POST['numResults'])) {
    $keys = $_POST['keys'];
    $num_results = $_POST['numResults'];
    $message = ting_subsearch_secondary_get_message($keys, $num_results);
  }
  drupal_json_output($message);
  drupal_exit();
}

/**
 * Implements hook_theme().
 */
function ting_subsearch_secondary_theme($existing, $type, $theme, $path) {
  return [
    'tss_message_box' => [
      'variables' => [
        'items' => NULL,
        'message' => NULL,
        'secondary_link' => NULL,
        'secondary_link_text' => NULL,
      ],
      'template' => 'templates/ting-subsearch-secondary--message-box',
    ],
    'tss_items_list' => [
      'variables' => ['items' => NULL],
      'template' => 'templates/ting-subsearch-secondary--message-box--items-list',
    ],
  ];
}

/**
 * Implements hook_ting_search_results_prefix().
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_ting_search_results_prefix($keys, $conditions, $results) {
  if (variable_get('ting_subsearch_secondary_position', 'before') == 'before') {
    return _ting_subsearch_secondary_search_trigger($keys, $conditions, $results, 'before');
  }
}

/**
 * Implements hook_ting_search_results_suffix().
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_ting_search_results_suffix($keys, $conditions, $results) {
  if (variable_get('ting_subsearch_secondary_position', 'before') == 'after') {
    return _ting_subsearch_secondary_search_trigger($keys, $conditions, $results, 'after');
  }
}

/**
 * Callback for triggering secondary search block render.
 *
 * @param $keys
 * @param $conditions
 * @param $results
 * @param $position
 *
 * @return string
 */
function _ting_subsearch_secondary_search_trigger($keys, $conditions, $results, $position) {
  // Return early if module is not configured.
  if (empty(variable_get('ting_subsearch_secondary_agency', '')) || empty(variable_get('ting_subsearch_secondary_profile', ''))) {
    return;
  }

  $num_results = $results->getNumTotalObjects();

  // Bail out if the user search returned more results than allowed.
  if ($num_results > variable_get('ting_subsearch_secondary_max', 100)) {
    return;
  }

  $factor = variable_get('ting_subsearch_secondary_factor', 2);

  // If user search returnes zero results we always try a secondary search.
  // Otherwise the results genre category ratio need to satisfy the factor.
  if ($num_results == 0 || ting_subsearch_check_genre_ratio($results, $factor)) {
    drupal_add_js([
      'tingSubsearchSecondary' => [
        'keys' => $keys,
        'numResults' => $num_results,
      ],
    ], 'setting');

    drupal_add_js(drupal_get_path('module', 'ting_subsearch_secondary') . '/js/subsearch_secondary.js', [
      'type' => 'file',
      'scope' => 'footer',
    ]);

    return '<div id="subsearch-secondary" class="' . $position . '"></div>';
  }
}

/**
 * Get secondary result message.
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_get_message($keys, $num_results) {
  $message = '';

  $secondary_result = ting_subsearch_do_secondary_search($keys, [
    'agency' => variable_get('ting_subsearch_secondary_agency', ''),
    'profile' => variable_get('ting_subsearch_secondary_profile', ''),
  ]);

  $secondary_num_results = $secondary_result->numTotalObjects;
  $secondary_result_min = variable_get('ting_subsearch_secondary_result_min', 100);

  // Bail out if secondary search didn't return enough results.
  if ($secondary_num_results < $secondary_result_min) {
    return $message;
  }

  $factor = variable_get('ting_subsearch_secondary_ps_factor', 2);

  if ($num_results == 0 || $secondary_num_results / $num_results >= $factor) {
    $items = [];
    $number_of_records_to_show = variable_get('ting_subsearch_secondary_number_of_results', 4);
    foreach ($secondary_result->collections as &$collection) {
      $build = ting_collection_view($collection, 'minimal');
      $markup = drupal_render($build);

      $items[] = [
        'markup' => $markup,
        'url' => 'https://bibliotek.dk/work/' . $collection->ding_entity_id,
      ];
      if (count($items) == $number_of_records_to_show) {
        break;
      }
    }

    $options = [
      '!secondary-link' => str_replace('[keys]', urlencode($keys), variable_get('ting_subsearch_secondary_search_link', '')),
      '!secondary-link-text' => variable_get('ting_subsearch_secondary_search_link_text', ''),
      '!keys' => $keys,
      '!num-results' => $num_results,
      '!secondary-num-results' => $secondary_num_results,
    ];

    if (variable_get('ting_subsearch_secondary_number_of_results', 4) == 0) {
      $message = t('If you search for "<strong>!keys</strong>" on !secondary-link-text instead you will get <strong>!secondary-num-results hits</strong>',
        $options
      );
    }
    else {
      $message = t('If you search for "<strong>!keys</strong>" on !secondary-link-text instead you will get <strong>!secondary-num-results hits</strong> where some of them is the following:',
        $options
      );
    }

    $message = theme('tss_message_box', [
      'items' => theme('tss_items_list', ['items' => $items]),
      'message' => $message,
      'secondary_link' => $options['!secondary-link'],
      'secondary_link_text' => t('See more materials at <span class="accent">bibliotek.dk</span>'),
    ]);
  }

  return $message;
}
