<?php

/**
 * @file
 * Ting subsearch using Bibliotek.dk service.
 */

use OpenSearch\OpenSearchStatementGroupRender;
use Ting\Search\DingProviderStrategy;
use Ting\Search\TingSearchRequest;
use Ting\Search\TingSearchResultInterface;

define('TING_SUBSEARCH_SECONDARY_BIBLIOTEK_DK_AGENCY', 190101);
define('TING_SUBSEARCH_SECONDARY_BIBLIOTEK_DK_PROFILE', 'default');

/**
 * Implements hook_ting_subsearch_info().
 */
function ting_subsearch_secondary_ting_subsearch_info() {
  $trigger_settings = [];
  $settings = [];

  // Trigger settings.
  $trigger_settings['ting_subsearch_secondary_max'] = [
    '#type' => 'textfield',
    '#title' => t('Maximum number of results for user search'),
    '#default_value' => variable_get('ting_subsearch_secondary_max', 100),
    '#description' => t("If the user search returned more results than this don't bother performing bibliotek.dk search."),
    '#element_validate' => ['element_validate_integer_positive'],
  ];
  $trigger_settings['ting_subsearch_secondary_factor'] = [
    '#type' => 'textfield',
    '#title' => t('Minimum ratio between nonfiction and fiction'),
    '#default_value' => variable_get('ting_subsearch_secondary_factor', 2),
    '#description' => t('The minimum ratio of nonfiction to fiction in user search result to trigger bibliotek.dk search. Use a decimal value for the ratio with "." as decimal separator'),
    '#element_validate' => ['ting_subsearch_factor_field_validate'],
  ];
  $trigger_settings['ting_subsearch_secondary_result_min'] = [
    '#type' => 'textfield',
    '#title' => t('Minimum number of results for bibliotek.dk search'),
    '#description' => t("If the bibliotek.dk subsearch returned less results than this don't bother showing any suggestions and links to bibliotek.dk."),
    '#default_value' => variable_get('ting_subsearch_secondary_result_min', 100),
    '#element_validate' => ['element_validate_integer_positive'],
  ];
  $trigger_settings['ting_subsearch_secondary_ps_factor'] = [
    '#type' => 'textfield',
    '#title' => t('Minimum ratio between bibliotek.dk and user search results'),
    '#default_value' => variable_get('ting_subsearch_secondary_ps_factor', 2),
    '#description' => t('The minimum ratio of between bibliotek.dk and user search results to trigger suggestion. Use a decimal value for the ratio with "." as decimal separator'),
    '#element_validate' => ['ting_subsearch_factor_field_validate'],
  ];

  // Other settings.
  $settings['ting_subsearch_secondary_number_of_results'] = [
    '#type' => 'textfield',
    '#title' => t('Number of results to show'),
    '#default_value' => variable_get('ting_subsearch_secondary_number_of_results', 4),
    '#description' => t('How many results from the bibliotek.dk subsearch should be shown to the user.'),
  ];
  $settings['ting_subsearch_secondary_position'] = [
    '#type' => 'radios',
    '#title' => t('Position of message'),
    '#options' => [
      'before' => t('Before'),
      'after' => t('After'),
    ],
    '#default_value' => variable_get('ting_subsearch_secondary_position', 'before'),
    '#description' => t('Should the bibliotek.dk suggestions and links be positioned before or after the search result?'),
  ];

  return [
    'ting_subsearch_secondary' => [
      'title' => t('Ting subsearch secondary'),
      'description' => t('Trigger bibliotek.dk subsearches and show suggestions and links to bibliotek.dk.'),
      'trigger_settings' => $trigger_settings,
      'settings' => $settings,
    ],
  ];
}

/**
 * Implements hook_theme().
 */
function ting_subsearch_secondary_theme($existing, $type, $theme, $path) {
  return [
    'ting_subsearch_secondary_message_box' => [
      'variables' => [
        'items' => NULL,
        'message' => NULL,
        'secondary_link' => NULL,
        'secondary_link_text' => NULL,
        'position' => NULL,
      ],
      'template' => 'templates/ting-subsearch-secondary-message-box',
    ],
    'ting_subsearch_secondary_message_box_items_list' => [
      'variables' => [
        'items' => NULL,
      ],
      'template' => 'templates/ting-subsearch-secondary-message-box-items-list',
    ],
  ];
}

/**
 * Theme process function for ting_subsearch_secondary_message_box.
 */
function template_process_ting_subsearch_secondary_message_box(&$variables) {
  $variables['items'] = theme('ting_subsearch_secondary_message_box_items_list', [
    'items' => $variables['items'],
  ]);
}

/**
 * Implements hook_opensearch_pre_execute().
 */
function ting_subsearch_secondary_opensearch_pre_execute($request) {
  if (get_class($request) != 'TingClientSearchRequest') {
    return;
  }

  $secondary_search = drupal_static('ting_subsearch_secondary_search');
  if ($secondary_search === TRUE) {
    $request->setProfile(TING_SUBSEARCH_SECONDARY_BIBLIOTEK_DK_PROFILE);
    $request->setAgency(TING_SUBSEARCH_SECONDARY_BIBLIOTEK_DK_AGENCY);
  }

  // Ensure that facet genreCategory is returned from the well, since we need
  // it to calculate genre ratio.
  // See: _ting_subsearch_secondary_ajax_placeholder().
  // See: ting_subsearch_get_genre_ratio().
  $facets = $request->getFacets();
  if (!in_array('facet.genreCategory', $facets)) {
    $facets[] = 'facet.genreCategory';
    $request->setFacets($facets);
  }
}

/**
 * Implements hook_ting_search_results_prefix().
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_ting_search_results_prefix($keys, $conditions, TingSearchResultInterface $search_result) {
  if (variable_get('ting_subsearch_secondary_position', 'before') == 'before') {
    return _ting_subsearch_secondary_ajax_placeholder($search_result);
  }
}

/**
 * Implements hook_ting_search_results_suffix().
 *
 * @throws \Exception
 */
function ting_subsearch_secondary_ting_search_results_suffix($keys, $conditions, TingSearchResultInterface $search_result) {
  if (variable_get('ting_subsearch_secondary_position', 'before') == 'after') {
    return _ting_subsearch_secondary_ajax_placeholder($search_result);
  }
}

/**
 * Get ajax placeholder HTML for secondary subsearch if conditions is met.
 */
function _ting_subsearch_secondary_ajax_placeholder(TingSearchResultInterface $search_result) {
  // Return early if module is not configured.
  if (empty(variable_get('ting_subsearch_secondary_agency', '')) || empty(variable_get('ting_subsearch_secondary_profile', ''))) {
    return;
  }

  $num_results = $search_result->getNumTotalObjects();

  // Bail out if the user search returned more results than allowed.
  if ($num_results > variable_get('ting_subsearch_secondary_max', 100)) {
    return;
  }

  $factor = variable_get('ting_subsearch_secondary_factor', 2);
  $ratio = ting_subsearch_get_genre_ratio($search_result);

  // If user search returnes zero results we always try a secondary search.
  // Otherwise the results genre category ratio need to satisfy the factor.
  if ($num_results == 0 || $ratio >= $factor) {
    $placeholder = ting_subsearch_get_ajax_placeholder_render_array('ting_subsearch_secondary');
    return drupal_render($placeholder);
  }
}

/**
 * Implements hook_ting_subsearch_ajax_placeholder_callback().
 */
function ting_subsearch_secondary_ting_subsearch_ajax_placeholder_callback(TingSearchResultInterface $search_result) {
  $message = '';

  // Mark the subsearch we're about to perform as a secondary search, which
  // should have bibliotek.dk agency and profil set in our implementation of
  // hook_opensearch_pre_execute().
  $secondary_search_flag = &drupal_static('ting_subsearch_secondary_search');
  $secondary_search_flag = TRUE;

  $search_request = $search_result->getSearchRequest();
  $secondary_result = ting_subseach_do_subsearch($search_request);

  drupal_static_reset('ting_subsearch_secondary_search');

  $secondary_num_results = $secondary_result->getNumTotalObjects();
  $secondary_result_min = variable_get('ting_subsearch_secondary_result_min', 100);

  // Bail out if secondary search didn't return enough results.
  if ($secondary_num_results < $secondary_result_min) {
    return $message;
  }

  $factor = variable_get('ting_subsearch_secondary_ps_factor', 2);
  // Get number of results for original search.
  $num_results = $search_result->getNumTotalObjects();

  if ($num_results == 0 || $secondary_num_results / $num_results >= $factor) {
    $items = [];

    $number_of_collections_to_show = variable_get('ting_subsearch_secondary_number_of_results', 4);
    $collections_to_show = array_slice($secondary_result->getTingEntityCollections(), 0, $number_of_collections_to_show);
    foreach ($collections_to_show as $collection) {
      $build = ting_collection_view($collection, 'minimal');
      $markup = drupal_render($build);

      $items[] = [
        'markup' => $markup,
        'url' => 'https://bibliotek.dk/work/' . $collection->ding_entity_id,
      ];
    }

    $message = '';

    $options = [
      '@keys' => $search_request->getFullTextQuery(),
      '!secondary-num-results' => $secondary_num_results,
    ];

    if ($number_of_collections_to_show == 0) {
      $message = t('If you search for "<strong>!keys</strong>" on bibliotek.dk instead you will get <strong>!secondary-num-results hits</strong>', $options);
    }
    elseif ($secondary_result->getNumCollections() < $number_of_collections_to_show) {
      // Avoid displaying the number of results/posts in these cases, because
      // it's confusing for the user. For example we might have several posts
      // but only 1 collection, so we could end up displayin something like
      // "you will get 36 hits", but we only show one posts.
      // See ting_search search_result.inc plugin that is dealing with a similar
      // problem.
      $message = t('If you search for "<strong>@keys</strong>" on bibliotek.dk instead you will get other results where some of them is the following:', $options);
    }
    else {
      $message = t('If you search for "<strong>@keys</strong>" on bibliotek.dk instead you will get <strong>!secondary-num-results hits</strong> where some of them is the following:', $options);
    }

    $secondary_link = url('https://bibliotek.dk/da/search/work', [
      'query' => [
        'search_block_form' => _ting_subsearch_secondary_get_secondary_keys($search_request),
      ],
    ]);

    $message = [
      '#theme' => 'ting_subsearch_secondary_message_box',
      '#items' => $items,
      '#message' => $message,
      '#secondary_link' => check_plain($secondary_link),
      '#secondary_link_text' => t('See more materials at bibliotek.dk'),
      '#position' => variable_get('ting_subsearch_secondary_position', 'before'),
    ];
  }

  return $message;
}

/**
 * Helper function to build search keys for search on bibliotek.dk.
 *
 * Used to ensure that the bibliotek.dk search result will be the same as the
 * result from the subsearch. Appends filters from the search request and CQL
 * query from the active ting_field_search profile to the user search.
 */
function _ting_subsearch_secondary_get_secondary_keys(TingSearchRequest $search_request) {
  // Start with the user search.
  $secondary_keys = $search_request->getFullTextQuery();

  $additional_keys = [];

  // See: opensearch_search_search().
  if (!empty($search_request->getFilters())) {
    $render = new OpenSearchStatementGroupRender(new DingProviderStrategy());
    try {
      $facet_keys = $render->renderStatements($search_request->getFilters());
      $additional_keys[] = $facet_keys;
    }
    catch (Exception $e) {
      // Something went wrong rendering facets. Move along without adding
      // anything, but log an exception.
      watchdog_exception('ting_susearch_secondary', $e);
    }
  }

  if (module_exists('ting_field_search') && $profile = ting_field_search_get_active_profile())  {
    if (!empty($profile->config['search_request']['query'])) {
      $additional_keys[] = $profile->config['search_request']['query'];
    }
  }

  // If we collected any additional keys append them to the user search.
  if (!empty($additional_keys)) {
    // Ensure the search will work
    $secondary_keys = '(' . $secondary_keys . ')';
    $secondary_keys .= ' AND ';
    $secondary_keys .= implode(' AND ', array_map(function ($part) {
      return "($part)";
    }, $additional_keys));
  }

  return $secondary_keys;
}
